---
import { Image } from 'astro:assets';
// 1. Añadimos getCollection aquí:
import { type CollectionEntry, getCollection } from 'astro:content'; 
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Header from '../components/Header.astro';

type Props = CollectionEntry<'blog'>['data'] & { id: string };

const { title, description, pubDate, updatedDate, heroImage, id } = Astro.props;

// --- LÓGICA DE ARTÍCULOS RELACIONADOS ---
const currentCategory = typeof id === 'string' ? id.split('/')[0] : '';
const allPosts = await getCollection('blog');

// Filtramos por la misma categoría, excluimos el post actual, ordenamos por fecha y tomamos 3
const relatedPosts = allPosts
    .filter(post => post.id.startsWith(currentCategory + '/') && post.id !== id)
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
    .slice(0, 3);
// ----------------------------------------

// --- CÁLCULO DE TIEMPO DE LECTURA ---
const currentPost = allPosts.find(post => post.id === id);
const textContent = currentPost ? currentPost.body : '';
// Dividimos por espacios para contar las palabras y calculamos (200 palabras por minuto)
const wordCount = textContent.split(/\s+/).length;
const readingTime = Math.max(1, Math.ceil(wordCount / 200)); 
// ------------------------------------

// --- JSON-LD PARA SEO AVANZADO (Google Discover) ---
const schema = {
    "@context": "https://schema.org",
    "@type": "TechArticle",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": Astro.url.toString()
    },
    "headline": title,
    "description": description,
    "image": heroImage ? new URL(heroImage.src, Astro.site || Astro.url).toString() : undefined,
    "author": {
        "@type": "Organization",
        "name": "Pathdawann",
        "url": new URL("/about", Astro.site || Astro.url).toString()
    },
    "datePublished": pubDate.toISOString(),
    "dateModified": (updatedDate || pubDate).toISOString()
};
// ---------------------------------------------------
---

<html lang="es">
    <head>
        {/* Pasamos heroImage a BaseHead y agregamos el script de Schema */}
        <BaseHead title={title} description={description} image={heroImage} />
        <script type="application/ld+json" set:html={JSON.stringify(schema)} />
    </head>

    <body class="bg-gray-50 dark:bg-gray-900 transition-colors">
        <Header />
        
        {/* CORRECCIÓN: La etiqueta <main> ahora envuelve todo el artículo */}
        <main class="w-full max-w-4xl mx-auto px-4 md:px-8 py-10 md:py-16">
            <article>
                
                {/* 1. IMAGEN PRINCIPAL (Ahora obedece al límite de 4xl) */}
                {heroImage && (
                    <div class="w-full mb-10 rounded-2xl overflow-hidden shadow-sm bg-gray-100 dark:bg-gray-800">
                        <Image 
                            width={1020} 
                            height={510} 
                            src={heroImage} 
                            alt={title} 
                            class="w-full h-auto max-h-125 object-cover" 
                        />
                    </div>
                )}
                
                {/* 2. COLUMNA DE LECTURA (Más estrecha para leer cómodo, 3xl) */}
                <div class="max-w-3xl mx-auto">
                    
                    {/* Cabecera del post */}
                    <div class="text-center mb-10">
                        
                        {/* Fechas y Tiempo de Lectura */}
                        <div class="text-gray-500 dark:text-gray-400 text-sm font-medium mb-4 flex justify-center items-center gap-3">
                            <FormattedDate date={pubDate} />
                            
                            {/* Punto separador */}
                            <span class="text-gray-300 dark:text-gray-600">&bull;</span>
                            
                            {/* Etiqueta de tiempo de lectura */}
                            <span class="flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                {readingTime} min de lectura
                            </span>

                            {updatedDate && (
                                <>
                                    <span class="text-gray-300 dark:text-gray-600">&bull;</span>
                                    <span class="italic text-gray-400">
                                        (Actualizado: <FormattedDate date={updatedDate} />)
                                    </span>
                                </>
                            )}
                        </div>

                        {/* Etiqueta de Categoría Segura */}
                        {typeof id === 'string' && id.includes('/') && (
                            <div class="mb-6">
                                <a href={`/blog/category/${id.split('/')[0]}`} class="inline-block px-3 py-1 text-xs font-bold uppercase tracking-wider text-blue-700 bg-blue-100 dark:text-blue-300 dark:bg-blue-900/50 rounded-full hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">
                                    {id.split('/')[0].replace('-', ' ')}
                                </a>
                            </div>
                        )}

                        {/* Título adaptativo */}
                        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 dark:text-white leading-tight mb-6">
                            {title}
                        </h1>
                        
                        <hr class="border-gray-200 dark:border-gray-800" />
                    </div>

                    {/* 3. CONTENIDO (Tu texto Markdown entra aquí) */}
                    <div class="prose prose-slate dark:prose-invert max-w-none text-lg text-gray-800 dark:text-gray-200 leading-relaxed">
                        <slot />
                    </div>
                    
                    {/* --- CAJA DE COMENTARIOS GISCUS --- */}
                    <div class="mt-16 pt-10 border-t border-gray-200 dark:border-gray-800">
                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-8">
                            Comentarios de la Comunidad
                        </h3>
                        
                        {/* PEGA TU SCRIPT DE GISCUS EXACTAMENTE AQUÍ DEBAJO */}
                        <script src="https://giscus.app/client.js"
                                data-repo="pathdawann/pathdawann-blog"
                                data-repo-id="R_kgDORYALjA"
                                data-category="General"
                                data-category-id="DIC_kwDORYALjM4C3Nfg"
                                data-mapping="pathname"
                                data-strict="0"
                                data-reactions-enabled="1"
                                data-emit-metadata="0"
                                data-input-position="bottom"
                                data-theme="dark_dimmed"
                                data-lang="es"
                                crossorigin="anonymous"
                                async>
                        </script>
                    </div>

                </div>
            </article>

            {/* --- SECCIÓN DE ARTÍCULOS RELACIONADOS --- */}
            {relatedPosts.length > 0 && (
                <div class="max-w-4xl mx-auto mt-16 pt-10 border-t border-gray-200 dark:border-gray-800">
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-8">
                        También te podría interesar...
                    </h3>
                    
                    <ul class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        {relatedPosts.map((post) => (
                            <li class="h-full">
                                <a href={`/blog/${post.id}/`} class="flex flex-col h-full bg-white dark:bg-gray-800 rounded-xl overflow-hidden shadow-sm hover:shadow-lg border border-gray-100 dark:border-gray-700 transition-all duration-300 group hover:-translate-y-1">
                                    
                                    {/* Imagen de la tarjeta relacionada */}
                                    <div class="w-full aspect-video overflow-hidden">
                                        {post.data.heroImage ? (
                                            <Image 
                                                width={400} 
                                                height={225} 
                                                src={post.data.heroImage} 
                                                alt={post.data.title} 
                                                class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" 
                                            />
                                        ) : (
                                            <div class="w-full h-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                                                <span class="text-gray-400 text-xs">Sin imagen</span>
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* Textos de la tarjeta */}
                                    <div class="p-5 flex flex-col grow">
                                        <h4 class="text-lg font-bold text-gray-900 dark:text-white mb-2 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors leading-tight line-clamp-2">
                                            {post.data.title}
                                        </h4>
                                        <p class="text-xs font-medium text-gray-500 dark:text-gray-400 mt-auto pt-2">
                                            <FormattedDate date={post.data.pubDate} />
                                        </p>
                                    </div>
                                    
                                </a>
                            </li>
                        ))}
                    </ul>
                </div>
            )}

            <button id="back-to-top" aria-label="Volver arriba" class="fixed bottom-8 right-8 z-50 p-3 bg-blue-600 text-white rounded-full shadow-lg opacity-0 pointer-events-none translate-y-5 transition-all duration-300 hover:bg-blue-700 hover:shadow-xl dark:bg-blue-500 dark:hover:bg-blue-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
            </button>

        </main>
        
        <Footer />
    </body>
</html>

<script>
    // Usamos astro:page-load para que funcione perfectamente con las View Transitions
    document.addEventListener('astro:page-load', () => {
        const backToTopBtn = document.getElementById('back-to-top');
        if (!backToTopBtn) return;

        // Mostrar el botón solo cuando bajamos más de 300px
        window.addEventListener('scroll', () => {
            if (window.scrollY > 300) {
                backToTopBtn.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-5');
                backToTopBtn.classList.add('opacity-100', 'translate-y-0');
            } else {
                backToTopBtn.classList.add('opacity-0', 'pointer-events-none', 'translate-y-5');
                backToTopBtn.classList.remove('opacity-100', 'translate-y-0');
            }
        });

        // Animación suave al hacer clic
        backToTopBtn.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    });
</script>