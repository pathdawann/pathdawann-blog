---
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets'; // ¡NUEVO! Importamos el optimizador de imágenes
import BaseHead from '../../../components/BaseHead.astro';
import Header from '../../../components/Header.astro';
import Footer from '../../../components/Footer.astro';
import FormattedDate from '../../../components/FormattedDate.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../../../consts';

export async function getStaticPaths() {
    const posts = await getCollection('blog');
    
    const categories = [...new Set(posts.map((post) => post.id.split('/')[0]))];
    
    return categories.map((category) => {
        const filteredPosts = posts.filter((post) => post.id.startsWith(category + '/'));
        filteredPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
        
        return {
            params: { category },
            props: { posts: filteredPosts },
        };
    });
}

const { category } = Astro.params;
const { posts } = Astro.props;

const categoryName = category.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
---

<!doctype html>
<html lang="es">
    <head>
        <BaseHead title={`${categoryName} - ${SITE_TITLE}`} description={SITE_DESCRIPTION} />
    </head>
    <body class="bg-gray-50 dark:bg-gray-900 transition-colors flex flex-col min-h-screen">
        <Header />
        
        <main class="w-full max-w-5xl mx-auto px-4 py-12 grow">
                {/* CABECERA DE LA CATEGORÍA */}
            <div class="mb-12 text-center">
                <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 dark:text-white mb-4">
                    Explorando: <span class="text-blue-600 dark:text-blue-400">{categoryName}</span>
                </h1>
                <p class="text-lg text-gray-500 dark:text-gray-400">
                    {posts.length} {posts.length === 1 ? 'artículo publicado' : 'artículos publicados'} en esta sección
                </p>
                <hr class="w-24 border-blue-600 dark:border-blue-400 mx-auto mt-8 border-2 rounded-full" />
            </div>

            <ul class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                {
                    posts.map((post) => (
                        <li class="h-full">
                            {/* CONTENEDOR DE LA TARJETA */}
                            <a href={`/blog/${post.id}/`} class="flex flex-col h-full bg-white dark:bg-gray-800 rounded-2xl overflow-hidden shadow-sm hover:shadow-lg border border-gray-100 dark:border-gray-700 transition-all duration-300 group hover:-translate-y-1">                                {/* IMAGEN */}
                                <div class="w-full overflow-hidden">
                                    {post.data.heroImage && (
                                        <Image 
                                            width={720} 
                                            height={360} 
                                            src={post.data.heroImage} 
                                            alt={post.data.title} 
                                            class="w-full h-56 md:h-48 object-cover transition-transform duration-500 group-hover:scale-105" 
                                        />
                                    )}
                                </div>

                                {/* CONTENIDO (Textos y Etiquetas) */}
                                <div class="flex flex-col grow p-6">
                                    
                                    {/* Metadatos: Etiqueta y Fecha */}
                                    <div class="flex items-center justify-between mb-4">
                                        <span class="inline-block px-3 py-1 text-[10px] font-bold uppercase tracking-wider text-blue-700 bg-blue-100 dark:text-blue-300 dark:bg-blue-900/50 rounded-full">
                                            {categoryName}
                                        </span>
                                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400">
                                            <FormattedDate date={post.data.pubDate} />
                                        </span>
                                    </div>
                                    
                                    {/* Título (Un poco más pequeño para encajar en 3 columnas) */}
                                    <h4 class="text-lg md:text-xl font-bold text-gray-900 dark:text-white mb-3 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors leading-tight">
                                        {post.data.title}
                                    </h4>
                                    
                                    {/* Descripción (Limitada a 3 líneas en lugar de 2 para compensar la imagen más baja) */}
                                    <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-3">
                                        {post.data.description}
                                    </p>
                                    
                                </div>
                            </a>
                        </li>
                    ))
                }
            </ul>

        </main>
        
        <Footer />
    </body>
</html>